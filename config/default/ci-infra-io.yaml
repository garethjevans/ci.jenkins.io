rbac:
  readSecrets: true
persistence:
  enabled: true
  size: 100Gi
controller:
  image: garethjevans/jenkins
  tag: 0.15.16-2.332.3-jdk11
  imagePullPolicy: IfNotPresent
  resources:
    requests:
      cpu: "50m"
      memory: "256Mi"
    limits:
      cpu: "2000m"
      memory: "4096Mi"
  JCasC:
    enabled: true
    defaultConfig: false
    configScripts:
      no-executors: |
        jenkins:
          numExecutors: 0
      matrix-settings: |
        jenkins:
          authorizationStrategy:
            globalMatrix:
              permissions:
                - "Overall/Administer:admin"
                - "Credentials/Create:admin"
                - "Overall/SystemRead:authenticated"
                - "Overall/Read:authenticated"
                - "Agent/ExtendedRead:authenticated"
                - "Job/ExtendedRead:authenticated"
                - "Overall/Read:anonymous"
                - "Job/Read:anonymous"
                - "View/Read:anonymous"
      security-realm: |
        jenkins:
          securityRealm:
            local:
              allowsSignup: false
              users:
                - id: "admin"
                  password: "p4ssw0rd"
      misc-jenkins: |
        jenkins:
          slaveAgentPort: 50000
      system-message: |
        jenkins:
          systemMessage: |
            <div>
              <h1>Demo Jenkins Server</h1>
            </div>
      markup-formatter: |
        jenkins:
          markupFormatter:
            rawHtml:
              disableSyntaxHighlighting: false
      crumb-issuer: |
        jenkins:
          crumbIssuer:
            standard:
              excludeClientIPFromCrumb: true
      misc-security: |
        security:
          apiToken:
            creationOfLegacyTokenEnabled: false
            tokenGenerationOnCreationEnabled: false
            usageStatisticsEnabled: true
      misc-unclassified: |
        unclassified:
          gitSCM:
            createAccountBasedOnEmail: false
            globalConfigEmail: "oscar@example.com"
            globalConfigName: "oscar"
          pollSCM:
            pollingThreadCount: 10
          timestamper:
            allPipelines: true
      jobs-settings: |
        jobs:
          - script: >
              def configuration = [
                [
                  name        : "rawlingsj",
                  excludes    : "",
                  trust       : "TrustPermission"
                ]
              ]

              configuration.each { jobConfig ->
                def config = [
                  displayName : jobConfig.name,
                  owner       : "rawlingsj",
                  repositories: "spring-petclinic",
                  excludes    : "",
                  trust       : "TrustPermission"
                ] << jobConfig
                organizationFolder(config.name) {
                  displayName(config.displayName)
                  organizations {
                    github {
                      repoOwner(config.owner)
                      apiUri("https://api.github.com")
                      credentialsId("github-access-token")
                      traits {
                        gitHubTagDiscovery()
                        cloneOptionTrait {
                          extension {
                            shallow(false)
                            noTags(false)
                            reference('')
                            timeout(10)
                            honorRefspec(false)
                          }
                        }
                      }
                    }
                  }
                  projectFactories {
                    workflowMultiBranchProjectFactory {
                      scriptPath("Jenkinsfile")
                    }
                  }
                  orphanedItemStrategy {
                    discardOldItems {
                      daysToKeep(1)
                    }
                  }
                  buildStrategies {
                    buildAnyBranches {
                      strategies {
                        buildChangeRequests {
                          ignoreTargetOnlyChanges(true)
                          ignoreUntrustedChanges(true)
                        }
                        buildRegularBranches()
                        buildTags {
                          atLeastDays("0")
                          atMostDays("7")
                        }
                      }
                    }
                  }
                  configure { node ->
                    def traits = node / navigators / 'org.jenkinsci.plugins.github__branch__source.GitHubSCMNavigator' / traits
                    traits << 'jenkins.scm.impl.trait.WildcardSCMSourceFilterTrait' {
                      includes(config.repositories)
                      excludes(config.excludes)
                    }
                    traits << 'org.jenkinsci.plugins.github__branch__source.BranchDiscoveryTrait' {
                      strategyId(1)
                    }
                    traits << 'org.jenkinsci.plugins.github__branch__source.OriginPullRequestDiscoveryTrait' {
                      strategyId(1)
                    }
                    traits << 'org.jenkinsci.plugins.github__branch__source.ForkPullRequestDiscoveryTrait' {
                      strategyId(1)
                      trust(class: 'org.jenkinsci.plugins.github_branch_source.ForkPullRequestDiscoveryTrait$' + config.trust)
                    }
                    traits << 'net.gleske.scmfilter.impl.trait.WildcardSCMHeadFilterTrait' {
                      includes('main master PR-*')
                      excludes()
                      tagIncludes('*')
                      tagExcludes()
                    }
                    traits << 'org.jenkinsci.plugins.github.label.filter.PullRequestLabelsBlackListFilterTrait' {
                      labels('on-hold ci-skip')
                    }
                    traits << 'jenkins.plugins.git.traits.LocalBranchTrait' {
                      // empty
                    }
                  }
                }
              }
      pipeline-library: |
        unclassified:
          globalLibraries:
            libraries:
              - defaultVersion: "master"
                implicit: true
                name: "pipeline-library"
                retriever:
                  modernSCM:
                    scm:
                      git:
                        id: "github-access-token"
                        remote: "https://github.com/garethjevans/pipeline-library.git"
      location: |
        unclassified:
          location:
            adminAddress: "nobody@jenkins.io"
            url: "http://34.149.103.207.nip.io/"
      agent-settings: |
        jenkins:
          clouds:
            - kubernetes:
                containerCapStr: "100"
                jenkinsUrl: "http://jenkins:8080"
                maxRequestsPerHostStr: "300"
                webSocket: true
                name: "kubernetes"
                namespace: "jenkins"
                podRetention: "Never"
                serverUrl: "https://kubernetes.default"
                podLabels:
                  # Required to be jenkins/<helm-release>-jenkins-slave as definede here
                  # https://github.com/helm/charts/blob/ef0d749132ecfa61b2ea47ccacafeaf5cf1d3d77/stable/jenkins/templates/jenkins-master-networkpolicy.yaml#L27
                  - key: "jenkins/jenkins-agent"
                    value: "true"
                templates:
                  - name: jnlp
                    nodeSelector: "kubernetes.io/os=linux"
                    containers:
                      - name: jnlp
                        image: "jenkins/inbound-agent:latest-jdk11"
                        resourceLimitCpu: "500m"
                        resourceLimitMemory: "512Mi"
                        resourceRequestCpu: "500m"
                        resourceRequestMemory: "512Mi"
                        args: 1d
                        alwaysPullImage: true
  overwritePlugins: false
  installPlugins: false
  sidecars:
    configAutoReload:
      env:
        # https://github.com/kiwigrid/k8s-sidecar#configuration-environment-variables
        - name: METHOD
          # Polling mode (instead of watching kube API)
          value: "SLEEP"
        # https://github.com/kiwigrid/k8s-sidecar#configuration-environment-variables
        - name: SLEEP_TIME
          # Time in seconds between two polls
          value: "60"
  ingress:
    enabled: true
    apiVersion: "networking.k8s.io/v1"
  probes:
    startupProbe:
      initialDelaySeconds: 500
    livenessProbe:
      initialDelaySeconds: 500
    readinessProbe:
      initialDelaySeconds: 500

